<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org/DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="userMapper">

	<select id="selectUser" resultType="User"
		resultMap="userResultMap">
		select user_no,user_email,user_password,user_nickname,user_admin,user_confirm
		from bmp_user
		where user_email=#{email}
	</select>
	
	<select id="selectGoogleUser" resultType="User"
		resultMap="userResultMap">
		select user_no,user_email,user_password,user_nickname,user_admin
		from bmp_user
		where user_email=#{email} and user_password=#{password}
	</select>

	<select id="getProfile" resultMap="userResultMap" parameterType="Follow">
		select user_no,user_email,user_nickname,user_birth,user_reg_date,user_dm,user_private,
			user_comment,file_name,countfollow,countfollower,follow_no,follow_permission
		from ulist
			left join (select * from bmp_follow where from_user=#{fromUser}) on (user_no=to_user)
		where user_no=#{toUser}
	</select>
	
	<insert id="addUser" parameterType="User">
		insert into bmp_user values
			(user_seq.nextval,#{email},#{password},#{nickname},null,null,null,sysdate,
			null,default,default,default,default,default,default)
	</insert>
	
	<update id="updateConfirm">
		update bmp_user set user_confirm='Y'
		where user_email=#{email}
	</update>
	
	<update id="updatePw">
		update bmp_user 
		set user_password=#{password},user_confirm='Y'
		where user_email=#{email}
	</update>
	
	<insert id="addFollow" useGeneratedKeys="false">
		<selectKey keyProperty="no" resultType="int" order="BEFORE">
			select follow_seq.nextval from dual
		</selectKey>
		insert into bmp_follow 
		values (#{no},#{permission},#{toUser},#{fromUser})
	</insert>
	
	<delete id="delFollow">
		delete from bmp_follow
		where follow_no=#{no}
	</delete>
	
	<resultMap type="User" id="userResultMap">
		<id property="no" column="user_no" />
		<result property="email" column="user_email" />
		<result property="password" column="user_password" />
		<result property="nickname" column="user_nickname" />
		<result property="birth" column="user_birth" />
		<result property="phone" column="user_phone" />
		<result property="regDate" column="user_reg_date" />
		<result property="delDate" column="user_del_date" />
		<result property="confirm" column="user_confirm" />
		<result property="alarm" column="user_alarm" />
		<result property="dm" column="user_dm" />
		<result property="sub" column="user_sub" />
		<result property="userPrivate" column="user_private" />
		<result property="admin" column="user_admin" />
		<result property="comment" column="user_comment" />
		<result property="fileName" column="file_name"/>
		<result property="follow" column="countfollow"/>
		<result property="follower" column="countfollower"/>
		<result property="post" column="post"/>
		<collection property="followInfo" resultMap="followResultMap"/>
	</resultMap>
	
	<resultMap type="Follow" id="followResultMap">
		<id property="no" column="follow_no"/>
		<result property="permission" column="follow_permission"/>
		<result property="toUser" column="to_user"/>
		<result property="fromUser" column="from_user"/>
	</resultMap>
	
</mapper>
